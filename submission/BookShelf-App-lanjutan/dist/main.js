(()=>{"use strict";const e="https://notes-api.dicoding.dev/v2";async function t(e){const t=await async function(e){const t=await e.text();try{return JSON.parse(t)}catch(e){return t}}(e);if(!e.ok){const n=t?.message||e.statusText||"Unknown error";throw new Error(n)}return t}async function n(n,o){const a=await fetch(`${e}/notes/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),i=await t(a);return i.data?.note??i.data??i}function o(e){let t={};if("string"==typeof e.body)try{t=JSON.parse(e.body)}catch(n){t={rawBody:e.body}}else"object"==typeof e.body&&null!==e.body&&(t=e.body);return{id:e.id??e._id??e.id_note,title:e.title??t.title??"Untitled",author:t.author??"",year:t.year??"",isComplete:Boolean(t.isComplete)}}function a(e){return{title:e.title,body:JSON.stringify({author:e.author,year:e.year,isComplete:!!e.isComplete}),createdAt:(new Date).toISOString()}}function i(e,{onToggle:t,onEdit:n,onDelete:o}){const a=document.createElement("div");a.classList.add("book-card"),a.setAttribute("data-bookid",e.id),a.setAttribute("data-testid","bookItem");const i=document.createElement("h3");i.setAttribute("data-testid","bookItemTitle"),i.innerText=e.title;const d=document.createElement("p");d.setAttribute("data-testid","bookItemAuthor"),d.innerText="Penulis: "+e.author;const r=document.createElement("p");r.setAttribute("data-testid","bookItemYear"),r.innerText="Tahun: "+e.year;const l=document.createElement("div"),c=document.createElement("button");c.setAttribute("data-testid","bookItemIsCompleteButton"),c.innerText=e.isComplete?"Belum selesai dibaca":"Selesai dibaca",c.addEventListener("click",()=>t(e.id));const s=document.createElement("button");s.setAttribute("data-testid","bookItemDeleteButton"),s.innerText="Hapus Buku",s.addEventListener("click",()=>o(e.id));const u=document.createElement("button");return u.setAttribute("data-testid","bookItemEditButton"),u.innerText="Edit Buku",u.addEventListener("click",()=>n(e)),l.append(c,s,u),a.append(i,d,r,l),a}let d=[],r=null;const l=document.getElementById("incompleteBookList"),c=document.getElementById("completeBookList"),s=document.getElementById("bookForm"),u=document.getElementById("bookFormSubmit"),m=document.getElementById("bookFormCancel"),y=document.getElementById("updateBookButton"),p=document.getElementById("searchBook"),b=document.getElementById("searchBookTitle"),k=function(){const e=document.createElement("div");return e.id="loadingIndicator",e.textContent="Memuat...",Object.assign(e.style,{position:"fixed",top:"12px",right:"12px",background:"rgba(255,255,255,0.95)",padding:"8px 12px",borderRadius:"6px",boxShadow:"0 2px 10px rgba(0,0,0,0.12)",display:"none"}),e}();function g(e=!0){k.style.display=e?"block":"none"}function f(){u.style.display="inline-block",y.style.display="none",m.style.display="none"}function h(){l.innerHTML="",c.innerHTML="";for(const e of d){const t=i(e,{onToggle:B,onEdit:e=>{var t;r=e.id,t=e,document.getElementById("bookId").value=t.id,document.getElementById("bookFormTitle").value=t.title,document.getElementById("bookFormAuthor").value=t.author,document.getElementById("bookFormYear").value=t.year,document.getElementById("bookFormIsComplete").checked=t.isComplete,u.style.display="none",y.style.display="inline-block",m.style.display="inline-block"},onDelete:I});e.isComplete?c.append(t):l.append(t)}}async function E(){const e=r||document.getElementById("bookId").value;if(!e)return alert("ID buku tidak ditemukan");const t=document.getElementById("bookFormTitle").value,i=document.getElementById("bookFormAuthor").value,l=document.getElementById("bookFormYear").value,c=document.getElementById("bookFormIsComplete").checked,u={id:e,title:t,author:i,year:l,isComplete:c};g(!0);try{const t=await n(e,a(u));d=d.map(n=>n.id===e?o(t):n),h(),s.reset(),r=null,f()}catch(e){console.error(e),alert("Gagal update: "+e.message)}finally{g(!1)}}async function I(n){if(confirm("Yakin ingin menghapus buku ini?")){g(!0);try{await async function(n){return t(await fetch(`${e}/notes/${n}`,{method:"DELETE"}))}(n),d=d.filter(e=>e.id!==n),h()}catch(e){console.error(e),alert("Gagal hapus: "+e.message)}finally{g(!1)}}}async function B(e){const t=d.find(t=>t.id===e);if(!t)return;const i={...t,isComplete:!t.isComplete};g(!0);try{const t=await n(e,a(i));d=d.map(n=>n.id===e?o(t):n),h()}catch(e){console.error(e),alert("Gagal mengubah status: "+e.message)}finally{g(!1)}}document.body.appendChild(k),p.addEventListener("submit",e=>{e.preventDefault();const t=b.value.trim().toLowerCase(),n=document.querySelectorAll("[data-testid='bookItem']");let o=0;for(const e of n){const n=e.querySelector("h3").innerText.toLowerCase(),a=e.querySelector("p").innerText.toLowerCase();n.includes(t)||a.includes(t)?(e.style.display="block",o++):e.style.display="none"}""!==t&&alert(o>0?`${o} buku ditemukan`:"Tidak ada buku yang cocok")}),s.addEventListener("submit",n=>{n.preventDefault(),r?E():async function(){const n={id:null,title:document.getElementById("bookFormTitle").value,author:document.getElementById("bookFormAuthor").value,year:document.getElementById("bookFormYear").value,isComplete:document.getElementById("bookFormIsComplete").checked};g(!0);try{const i=await async function(n){const o=await fetch(`${e}/notes`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),a=await t(o);return a.data?.note??a.data??a}(a(n));d.push(o(i)),h()}catch(e){console.error(e),alert("Gagal menambahkan: "+e.message)}finally{g(!1)}}(),s.reset()}),m.addEventListener("click",()=>{s.reset(),r=null,f()}),y.addEventListener("click",()=>E()),async function(){g(!0);try{const n=await async function(){const n=await fetch(`${e}/notes`),o=await t(n);return o.data?.notes??o.notes??o.data??[]}();d=(Array.isArray(n)?n:[]).map(o),h()}catch(e){console.error(e),alert("Gagal memuat data: "+e.message)}finally{g(!1)}}()})();